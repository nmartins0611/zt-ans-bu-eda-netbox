= Lab Guide: Configuring a NetBox Dynamic Inventory
:doctype: book
:notoc:
:notoc-title: Table of Contents
:sectnums:
:icons: font

_A guide to managing hosts and groups by configuring NetBox as a dynamic inventory source for Ansible Automation Platform._

---

== Introduction to Dynamic Inventories

An inventory in **Ansible Automation Platform** is a collection of hosts for running jobs. If your inventory changes frequently, static solutions may not be ideal. **Dynamic Inventories** solve this by automating the process of tracking hosts from multiple sources of truth, such as cloud providers or CMDBs like NetBox.

Ansible Automation Platform connects with external inventories using plugins, which are the preferred method. The NetBox Certified Ansible Collection includes modules for:

* **Dynamic Inventory:** Fetching real-time data.
* **State Definition:** Ensuring configurations align with your intended design.
* **Querying Network Data:** Extracting details for use in playbooks.

In this lab, you'll explore how Ansible Automation Platform syncs with NetBox and integrates with Event-Driven Ansible for real-time network updates.

[IMPORTANT]
====
.Lab Credentials
====
.Ansible Automation Platform (AAP)
* **Username:** `admin`
* **Password:** `ansible123!`

.NetBox
* **Username:** `admin`
* **Password:** `netbox`



== Task 1: Create the Inventory Project

First, you will create a project in AAP that contains the NetBox dynamic inventory plugin configuration file.

.   **Navigate to the Projects page** in the `AAP` tab by going to **Automation Execution** → **Projects**. Then, **click** the **Create project** button.

.   **Fill out the form** with the following details: *Name:* `netbox-inventory-project`, *Organization:* `Default`, *Execution environment:* `netbox-ee`, *Source control type:* `Git`, *Source control URL:* `https://github.com/leogallego/netbox-inventory.git`.

.   **Save the project** by clicking the blue **Create project** button.

.   **Review the inventory plugin file.** The `netbox.netbox.nb_inventory` plugin is configured via a file in the Git repository. The content of the `netbox_inventory` file looks like this:
+
[source,yaml]
----
plugin: netbox.netbox.nb_inventory
config_context: true
validate_certs: False
group_by:
  - platforms
  - device_roles
  - sites
compose:
  ansible_network_os: platform.name
  ansible_host: custom_fields.host
  ansible_port: custom_fields.port
----

---

== Task 2: Create the NetBox Credential

Next, you will create a custom credential type and a credential in AAP to securely store the NetBox API token.

.   **Create a Custom Credential Type.** Go to **Automation Execution** → **Infrastructure** → **Credential Types** and click **Create credential type**. Enter `NetBox` for the *Name* and `NetBox API custom credential` for the *Description*. Paste the following into the *Input configuration*:
+
[source,yaml]
----
fields:
  - id: NETBOX_API
    type: string
    label: NetBox Host URL
  - id: NETBOX_TOKEN
    type: string
    label: NetBox API Token
    secret: true
required:
  - NETBOX_API
  - NETBOX_TOKEN
----
+
Paste the following into the *Injector configuration*:
+
[source,yaml]
----
env:
  NETBOX_API: '{{ NETBOX_API }}'
  NETBOX_TOKEN: '{{ NETBOX_TOKEN }}'
----
+
Finally, **click** **Create credential type**.

.   **Get the NetBox API Token.** Go to the `netbox web` tab and log in. In the left sidebar, scroll to the bottom, expand the **Admin** menu, and click **API Tokens**. **Copy** the **Key Token** to your clipboard.
+
image::Feb-05-2025_at_15.06.21-image.png[Copying the NetBox API Token, opts="border"]

.   **Create the NetBox Credential in AAP.** Return to the `AAP` tab. Go to **Automation Execution** → **Infrastructure** → **Credentials** and click **Create credential**. Fill in the details: *Name:* `NetBox API`, *Organization:* `Default`, *Credential Type:* `NetBox`, *NetBox Host URL:* `http://netbox:8000`, *NetBox API Token:* `0123456789abcdef0123456789abcdef01234567`. **Click** **Create credential**.
+
image::Feb-06-2025_at_12.11.09-image.png[Completed NetBox credential in AAP, opts="border"]

---

== Task 3: Create the Dynamic Inventory

Now, you will create the inventory that will use NetBox as its source.

.   **Navigate to the Inventories page** in the `AAP` tab by going to **Automation Execution** → **Infrastructure** → **Inventories**.

.   **Create a new inventory.** **Click** **Create inventory** → **Create inventory**. Enter `NetBox Dynamic Inventory` for the *Name* and select `Default` for the *Organization*. **Click** **Create inventory**.

---

== Task 4: Add the Dynamic Source

Finally, you will configure the dynamic source within your new inventory.

.   **Navigate to the Sources tab.** Inside the `NetBox Dynamic Inventory`, click the **Sources** tab. Notice that the **Hosts** tab is currently empty.
+
image::Feb-05-2025_at_15.38.09-image.png[Inventory Sources tab, opts="border"]

.   **Create a new source.** **Click** the blue **Create source** button and fill out the form: *Name:* `netbox-inventory-source`, *Execution Environment:* `netbox-ee`, *Source:* `Sourced from a project`, *Credential:* `NetBox API`, *Project:* `netbox-inventory-project`, *Inventory file:* `netbox_inventory`, *Verbosity:* `(1) Info`. Under *Options*, check both `Overwrite` and `Update on launch`. Set *Cache timeout (seconds)* to `120`. **Click** **Create source**.
+
image::Feb-05-2025_at_15.41.48-image.png[Completed inventory source form, opts="border"]

.   **Sync the inventory source.** On the details page for the new source, **click** the **Launch inventory update** button in the top right.
+
image::Feb-06-2025_at_12.16.55-image.png[Launch inventory update button, opts="border"]

.   **Verify the hosts.** Go back to the `NetBox Dynamic Inventory` details and click the **Hosts** tab. You should now see the Cisco Catalyst 8000v device, which was dynamically imported from NetBox.
+
image::Feb-06-2025_at_12.18.18-image.png[Host successfully imported from NetBox, opts="border"]

---

== Next Steps

Press the `Next` button below to proceed to the next challenge.

