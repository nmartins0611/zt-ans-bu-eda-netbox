= Lab Guide: Event-Driven Ansible and NetBox in Action
:doctype: book
:icons: font

_A guide to using Event-Driven Ansible to automatically respond to real-time changes in NetBox._

---

== Introduction

Now it's time to see everything in action! In this workshop, you'll see Event-Driven Ansible (EDA) and NetBox interact by making real-time changes to your network. First, you'll modify an existing device's configuration in NetBox, triggering Ansible to detect and apply updates automatically. Then, you'll add a brand-new device, showcasing how Ansible reacts to new inventory entries by running predefined job templates.

Switch to the `netbox web` tab so we can apply changes there. NetBox has been set up with one device called `cat1` and all necessary dependencies.

[IMPORTANT]
====
.Lab Credentials
====
.Ansible Automation Platform (AAP)
* **Username:** `admin`
* **Password:** `ansible123!`

.NetBox
* **Username:** `admin`
* **Password:** `netbox`
====
====

---

== Task 1: Reviewing NetBox Setup

First, let's explore the existing configuration in NetBox.

.   **Examine the `cat1` device.** In the `netbox web` tab, go to **Devices** â†’ **Devices** in the left sidebar. You will see a pre-configured Cisco Catalyst 8000v device named `cat1`. Notice its pre-populated fields like *Site*, *Role*, *Manufacturer*, and *Type*.
+
image::Feb-06-2025_at_01.05.01-image.png[Device details in NetBox, opts="border"]

.   **Review the Custom Fields.** Navigate to **Customization** â†’ **Custom Fields**. You will see fields for `ansible_host` and `ansible_port`, used by the dynamic inventory.
+
image::Feb-06-2025_at_01.17.01-image.png[Custom Fields in NetBox, opts="border"]

.   **Review the Config Contexts.** Navigate to **Provisioning** â†’ **Config Contexts**. You will see contexts for `NTP Servers` and `Login Banner`, storing custom data for device configurations.
+
image::Feb-06-2025_at_01.17.19-image.png[Config Contexts in NetBox, opts="border"]

---

== Task 2: Configure the NetBox Webhook

To configure NetBox to send notifications to Ansible Automation Platform when an event occurs, you will now create a webhook. This is required before creating Event Rules.

.   **Navigate to Webhooks** in the NetBox `Operations` menu by clicking on **Webhooks**.

.   **Create a new webhook.** **Click** the green **+ Add** button and fill out the form: *Name:* `EDA Webhook`, *URL:* `http://control:5001/endpoint`. **Uncheck** the *SSL Verification* box. Leave the other fields as they are and **click** **Create**.
+
image::Feb-06-2025_at_01.32.09-image.png[Creating a webhook in NetBox, opts="border"]

---

== Task 3: Create NetBox Event Rules

Now you will create Event Rules to specify which NetBox events should be forwarded to the webhook you just created.

.   **Create the `ntp_servers` and `login_banner` Event Rules.** Go to **Operations** â†’ **Event Rules** and **click** the green **+ Add** button. Fill in the details: *Name:* `ntp_servers`, *Object types:* `Extras > Config Context` (Tip: type "context" to filter), *Event types:* `Object updated`, *Action type:* `Webhook`, *Webhook:* `EDA Webhook`. **Click** **Create**. Then, **repeat** these steps to create a second rule named `login_banner` with the same settings.
+
image::Feb-07-2025_at_02.17.39-image.png[Creating an Event Rule, opts="border"]

.   **Create the `new_device` Event Rule.** **Create** a third rule with slightly different settings: *Name:* `new_device`, *Object types:* `DCIM > Device` (Tip: type "device" to filter), *Event types:* `Object created`, *Action type:* `Webhook`, *Webhook:* `EDA Webhook`. **Click** **Create**.
+
image::Feb-07-2025_at_02.25.26-image.png[Creating the new device Event Rule, opts="border"]

---

== Task 4: Trigger an NTP Configuration Update

Now you will apply a change in NetBox and observe how it triggers the corresponding Job Template in AAP.

[IMPORTANT]
====
Before you begin, you can verify the current configuration in the `AAP` tab by navigating to the `cat1` host within your `NetBox Dynamic Inventory`. Notice it has only two NTP servers configured.
image::Feb-07-2025_at_02.36.00-image.png[Initial NTP configuration on cat1, opts="border"]
====

.   **Update the NTP Config Context.** In the `NetBox` tab, go to **Provisioning** â†’ **Config Contexts** and click on `ntp_servers`. **Click** the orange **EDIT** button. In the *Data* field, add a third NTP server (`time-c-g.nist.gov`). The final JSON should look like this:
+
[source,json]
----
{
 "ntp_servers": [
     "time-a-g.nist.gov",
     "time-b-g.nist.gov",
     "time-c-g.nist.gov"
 ]
}
----
+
[WARNING] Pay attention to the commas!
+
**Click** the **Save** button.

---

== Task 5: Observe Event-Driven Ansible in Action

Switch to the `AAP` tab to see the automated response triggered by your NetBox change.

.   **Check the Rulebook Activation.** Go to **Automation Decisions** â†’ **Rulebook Activations**. A quick way to see if an event was triggered is to check the **Fire count** for your activation; it should have increased.
+
image::Feb-07-2025_at_02.56.56-image.png[Increased fire count, opts="border"]

.   **Review the Rule Audit.** For more detail, go to the **Rule Audit** section. You will see which Job Template was triggered (it should be `NTP updates`). **Click** on the entry, then go to the **Events** tab. **Click** on the `ansible.eda.webhook` entry to see the pop-up containing the actual payload sent by NetBox that triggered the rule.
+
image::Feb-07-2025_at_02.59.55-image.png[Rule Audit showing the event details, opts="border"]
image::Feb-07-2025_at_03.01.39-image.png[Event payload details, opts="border"]

.   **Review the Job Template output.** You can see the detailed output of the automation job that ran by navigating to **Automation Execution** â†’ **Jobs** and finding the `Configure NTP Servers` job run.
+
NOTE: It might take a few seconds for the event to trigger and the job to appear.

---

== Task 6: Trigger a Login Banner Update

Now, try it yourself! Switch to the `NetBox` tab and update the `login_banner` Config Context. Observe the corresponding job run in AAP by checking the Rule Audit and Jobs pages.

---

== Task 7: Trigger a New Device Workflow

Finally, you will add a new device to NetBox and see how EDA triggers a multi-step provisioning workflow defined in AAP.

.   **Create a new device in NetBox.** Go to **Devices** â†’ **Devices** and **click** the green **+ Add** button. Fill out the form with the following details: *Name:* `cat2`, *Device Role:* `edge-router`, *Device Type:* `cisco-c8000v`, *Site:* `cisco-live-emea`, *Platform:* `cisco.ios.ios`. Under *Custom Fields*, set *Host* to `cisco2` and *Port* to `22`. **Click** **Create**.
+
image::Feb-07-2025_at_03.18.35-image.png[Adding a new device in NetBox, opts="border"]

.   **Observe the workflow execution in AAP.** In the `AAP` tab, check the **Fire count** in Rulebook Activations and the output in **Rule Audit** again. You should see that the `New Device Added` rule was triggered. Go to **Automation Execution** â†’ **Jobs** and verify that the **Provision New Device Workflow** ran successfully.
+
image::Feb-07-2025_at_03.21.47-image.png[Successful workflow execution for the new device, opts="border"]

.   **Verify the new device configuration.** Go to your `NetBox Dynamic Inventory` (**Automation Execution** â†’ **Infrastructure** â†’ **Inventories** â†’ `NetBox Dynamic Inventory`) â†’ **Hosts**. You should now see both `cat1` and `cat2`. Click on `cat2` to verify that its configuration context includes the three NTP servers and your new login banner, all sourced dynamically from NetBox and applied by the workflow.
+
image::Feb-07-2025_at_04.36.13-image.png[Configuration of the new cat2 device, opts="border"]

---

== Congratulations!

You have finished the Event-Driven Ansible and Network Sources of Truth workshop! ðŸŽ‰

== Troubleshooting

[WARNING]
====
.NetBox Worker Issues
If AAP is not showing a **Fire count** or jobs in **Rule Audit**, the NetBox worker might be misbehaving. Go to the **NetBox** tab, click **Admin > Background Tasks**, and check if workers are running. If not, go to the `netbox term` tab and run `docker compose --project-directory=/tmp/netbox-docker stop` followed by `docker compose --project-directory=/tmp/netbox-docker up -d netbox netbox-worker`.
====

[WARNING]
====
.Job Templates Not Pre-created?
If Job Templates are missing, run the following command in the `AAP Terminal` tab:
[source,bash]
----
su - rhel -c 'cd /home/rhel; ansible-navigator run /home/rhel/5-eda-playbooks.yml --mode stdout --penv _SANDBOX_ID'
----
====

[WARNING]
====
.NetBox Devices Missing?
If you don't see devices in NetBox, run the following command in the `AAP Terminal` tab:
[source,bash]
----
su - rhel -c 'cd /home/rhel/netbox-setup; ansible-navigator run /home/rhel/netbox-setup/netbox-setup.yml -Fields in ï¿½
