= Lab Guide: Event-Driven Ansible Workflows
:doctype: book
:notoc:
:notoc-title: Table of Contents
:sectnums:
:icons: font

_A guide to connecting multiple playbooks using conditional logic in a Workflow Job Template._

---

== Lab Briefing

A **Workflow Job Template** is a series of connected Job Templates that are executed in a specific order to achieve a desired outcome. While an individual Job Template handles the tasks in a single playbook, a Workflow Job Template is designed to manage more complex automation scenarios involving multiple playbooks and decision-making processes based on success or failure.

Only Workflow Job Templates have a **Workflow Visualizer**, which provides a graphical interface for linking Job Templates together.

---

== Lab Guide: Hands-On Tasks

In this exercise, you will explore a pre-created Workflow Job Template that is linked to the `New Device Added` rule in your rulebook.

[WARNING]
====
Remember not to confuse a **Job Template**, a **Jinja template**, and a **Workflow Job Template**. They are three separate concepts.
====

[IMPORTANT]
====
.Lab Credentials
====
.Ansible Automation Platform (AAP)
* **Username:** `admin`
* **Password:** `ansible123!`

.NetBox
* **Username:** `admin`
* **Password:** `netbox`


=== Task 1: Explore the Workflow Job Template

First, you will locate and explore the pre-configured workflow.

.   **Navigate to the Templates page** in the `AAP` tab by going to **Automation Execution** â†’ **Templates**. **Look** for the workflow named **Provision New Device Workflow** and **click** on its name to open the details page.
+
image::Feb-06-2025_at_17.54.01-image.png[Workflow Job Template in the list, opts="border"]
+
Then, on the *Details* tab for the workflow, **click** the blue **View workflow visualizer** button in the top right.
+
image::Feb-06-2025_at_17.57.36-image.png[View workflow visualizer button, opts="border"]

---

=== Task 2: Understand the Workflow Visualizer

In this view, you can see a graphical representation of the relationship between the different Job Templates. This workflow is composed of two Job Templates that will run in parallel:

* `Configure NTP Servers` (aliased as `NTP`)
* `Configure Login Banner` (aliased as `Banner`)

---

=== Task 3: Manually Launch the Workflow

Finally, you will manually launch the workflow to see it in action. In the next exercise, you will see how this same workflow is triggered automatically when a new device is added to NetBox.

.   **Launch the workflow.** While in the **Workflow Visualizer**, **click** the three dots (`...`) in the top left, just below the workflow name, and select **Launch workflow** from the dropdown menu.
+
image::Feb-06-2025_at_18.01.33-image.png[Launching the workflow from the visualizer, opts="border"]
+
**Observe the execution.** The workflow will run the two Job Templates in parallel against all existing devices in your `NetBox Dynamic Inventory`. You can watch the progress in the real-time visualizer.
+
image::Feb-07-2025_at_01.57.45-image.png[Workflow running successfully, opts="border"]

---

== Next Steps

Press the `Next` button below to proceed to the next challenge, where you will trigger this workflow automatically using an event from NetBox.

== Troubleshooting

[WARNING]
====
.Job Templates Not Pre-created?
If the Job Templates are missing, the `NetBox Dynamic Inventory` may not have been created correctly. First, go back to the inventory creation exercise and complete it. Then, run the following command in the `AAP Terminal` tab:
[source,bash]
----
su - rhel -c 'cd /home/rhel; ansible-navigator run /home/rhel/5-eda-playbooks.yml --mode stdout --penv _SANDBOX_ID'
----
====

[WARNING]
====
.NetBox Not Responding?
NetBox needs a couple of minutes to start up. If you cannot see the NetBox login screen, go to the `netbox term` tab and run the following commands:
[source,bash]
----
docker compose --project-directory=/tmp/netbox-docker stop
docker compose --project-directory=/tmp/netbox-docker up -d netbox netbox-worker
----
====

[WARNING]
====
.NetBox Devices Missing?
For the Dynamic Inventory to work, some pre-loaded content is needed in NetBox. If you can't see devices in the NetBox UI, run the following command in the `AAP Terminal` tab:
[source,bash]
----
su - rhel -c 'cd /home/rhel/netbox-setup; ansible-navigator run /home/rhel/netbox-setup/netbox-setup.yml --mode stdout --penv _SANDBOX_ID'
----
====
