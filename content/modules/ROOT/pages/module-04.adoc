= Lab Guide: Integrating NetBox with Event-Driven Ansible
:doctype: book
:toc:
:toc-title: Table of Contents
:sectnums:
:icons: font

_A guide to setting the rules for conditions and actions that Event-Driven Ansible will use to react to events from NetBox._

---

== Introduction

**Ansible Automation Platform** is a powerful tool for network automation, and integrating it with **NetBox** enhances its capabilities. By using NetBox as a Network Source of Truth (NSoT), Ansible can ensure accuracy in managing network devices, connections, and services.

By leveraging **Event-Driven Ansible (EDA)**, Ansible Automation Platform can react to real-time events from NetBox, such as new devices being added or configuration changes being approved. This eliminates the need for manual intervention or scheduled tasks, enabling fully automated, dynamic network management.

[IMPORTANT]
====
.Lab Credentials
====
.Ansible Automation Platform (AAP)
* **Username:** `admin`
* **Password:** `ansible123!`

.NetBox
* **Username:** `admin`
* **Password:** `netbox`
====
====

---

== Task 1: Create the Event-Driven Ansible Project

First, you will create a project in the **Automation Decisions** section of AAP. This project will contain the rulebooks that define how to react to events from NetBox.

[WARNING]
====
Currently, not all fields of an EDA Project can be edited after creation. If you make a mistake in the "Source control URL," you will need to delete and recreate the project.
====

.   **Navigate to the Projects page** in the `AAP` tab by going to **Automation Decisions** → **Projects**. **Click** the **Create project** button and **fill out the form** with the following details: *Name:* `netbox-rulebooks-project`, *Organization:* `Default`, *Source control type:* `Git`, *Source control URL:* `https://github.com/leogallego/aap-netbox-rulebooks-cisco-live.git`.
+
image::Feb-06-2025_at_00.09.45-image.png[Creating the EDA Project, opts="border"]
+
**Save the project** by clicking the blue **Create project** button at the bottom. Wait for the project *Status* to show a green checkmark and read **Completed** before moving on.
+
image::Feb-06-2025_at_00.10.57-image.png[Successful project sync, opts="border"]

---

== Task 2: Explore EDA Credentials

This credential allows Event-Driven Ansible to run the desired action (a Job Template in Automation Execution) when a condition is triggered.

.   **Navigate to the Credentials page** by going to **Automation Decisions** → **Infrastructure** → **Credentials**. You will notice there is an `AAP` credential already created for you. This was pre-loaded because the URL is internal to the workshop platform. Take a look at its configuration, but be careful not to change any settings.
+
image::Feb-06-2025_at_00.12.02-image.png[Pre-loaded AAP credential for EDA, opts="border"]
+
**Click** the **Cancel** button to leave the Credential screen.

---

== Task 3: Create the Rulebook Activation

Now you will create the **Rulebook Activation**, which is the service that will actively listen for events based on the rules in the project you created.

[WARNING]
====
Ensure you fill out all fields correctly. Like EDA Projects, Rulebook Activations currently cannot be edited. An error will require you to delete and re-create it.
====

.   **Navigate to the Rulebook Activations page** by going to **Automation Decisions** → **Rulebook Activations**. **Click** on **Create rulebook activation**. **Fill out the form** with the following details: *Name:* `NetBox Rulebooks`, *Organization:* `Default`, *Project:* `netbox-rulebooks-project`, *Rulebook:* `netbox-webhook.yml`, *Credential:* `AAP`, *Decision environment:* `NetOps Decision Environment`, *Restart policy:* `Always`, *Log level:* `Info`, ensure *Rulebook activation enabled?* is checked.

.   **Save the activation.** Leave the rest of the fields as-is and **click** the blue **Create rulebook activation** button at the bottom. You will see the details page for the new activation. The *Activation status* will initially show as "Starting," but it should change to **Running** after a few seconds if everything was successful.
+
image::Feb-05-2025_at_16.07.10-image.png[Running Rulebook Activation, opts="border"]

---

== Task 4: Explore the Rulebook

Below is the content of the rulebook you just activated. It contains five rules that define the conditions EDA will listen for from the NetBox webhook.

[source,yaml]
----
---
- name: Listen for NetBox events on a webhook
  hosts: all
  sources:
    - ansible.eda.webhook:
        host: 0.0.0.0
        port: 5001

  rules:
  - name: NTP updates
    condition: event.payload.event == "updated" and event.payload.model == "configcontext" and event.payload.data.name == "ntp_servers"
    action:
      run_job_template:
        organization: "Default"
        name: "Configure NTP Servers"

  - name: VLAN created
    condition: event.payload.event == "created" and event.payload.model == "vlan"
    action:
      run_job_template:
        organization: "Default"
        name: "Configure VLANs"

  - name: VLAN deleted
    condition: event.payload.event == "deleted" and event.payload.model == "vlan"
    action:
      run_job_template:
        organization: "Default"
        name: "Configure VLANs"

  - name: Update login banner
    condition: event.payload.event == "updated" and event.payload.model == "updated" and event.payload.data.name == "login_banner"
    action:
      run_job_template:
        organization: "Default"
        name: "Configure Login Banner"

  - name: New Device Added
    condition: event.payload.event == "created" and event.payload.model == "device"
    action:
      run_workflow_template:
        organization: "Default"
        name: "Provision New Device Workflow"
----

.What This Rulebook Does
[%collapsible]
====
This rulebook uses the `ansible.eda.webhook` source plugin to listen for events sent from NetBox. When NetBox sends an event, EDA receives the payload and evaluates it against the conditions in each rule (e.g., NTP Updates, VLAN Created, New Device Added).

Each rule has its own set of conditions and a corresponding action. For example, if a `created` event for a `vlan` model is received, the rulebook will launch the "Configure VLANs" Job Template.

NOTE: Ansible Rulebooks operate differently than Ansible Playbooks. A Rulebook Activation runs constantly, listening for events, while a Job Template is executed on demand.
====

---

== Next Steps

Press the `Next` button below to proceed to the next challenge.

== Troubleshooting

[WARNING]
====
* NetBox needs a couple of minutes to start up. If you can't see the NetBox login screen, go to the `netbox term` tab and run `docker compose --project-directory=/tmp/netbox-docker stop` followed by `docker compose --project-directory=/tmp/netbox-docker up -d netbox netbox-worker`.

* For the Dynamic Inventory to work, some pre-loaded content is needed in NetBox. If you don't see any devices in the NetBox UI, run the following command in the `AAP` terminal:
+
[source,bash]
----
su - rhel -c 'cd /home/rhel/netbox-setup; ansible-navigator run /home/rhel/netbox-setup/netbox-setup.yml --mode stdout --penv _SANDBOX_ID'
----
====
